# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#

#.env.default
#SLACK_URL="https://hooks.slack.com/services/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"
#DELIVER_USERNAME = "brunoteixeiralc@gmail.com"
#DELIVER_APP_IDENTIFIER = "br.com.afazer"

update_fastlane

default_platform(:ios)

platform :ios do

desc "Run tests"
    lane :tests do
    run_tests(code_coverage:true,
        clean:true,
        project: "afazer.xcodeproj",
        devices: ["iPhone 5s"],
        scheme: "afazerUITests",
        slack_message:"Successfully run UI Tests",
            success:true)

end

desc "Generate screenshots and upload to apple store"
    lane :screenshots do
        capture_screenshots(scheme: "afazer")
        frameit(silver: true)
        appstore(skip_binary_upload: true, skip_metadata: true)
        slack(message:"Successfully uploaded screenshots to itunes connect", success:true)
end

desc "Beta app"
    lane :beta do
        match(type: "development", readonly: true)
        increment_build_number(
            build_number: latest_testflight_build_number + 1,
            xcodeproj: "afazer.xcodeproj"
        )
        changelog = prompt(
            text: "Changelog: ",
            multi_line_end_keyword: "END"
        )
        build_app(scheme: "afazer",
            clean:true,
            project: "afazer.xcodeproj",
            include_bitcode: true,
            export_method:"development"
        )
        pilot(changelog: changelog)
        slack(message: "Successfully uploaded to Test Flight",
            success:true)
end

desc "Release app"
    lane :release do
        match(type: "appstore", readonly: true)
        build_app(scheme: "afazer",
            clean:true,
            project: "afazer.xcodeproj",
            include_bitcode: true,
            export_method:"app-store"
        )
        appstore(skip_metadata:true,
            skip_screenshots:true,
            submit_for_review:true,
            automatic_release:true
        )
        slack(message: "Successfully uploaded a new App Store build",
            success:true)
end

error do |lane, exception|
    slack(
        message: exception.message,
        success: false
    )
end

end
